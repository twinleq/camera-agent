# Работа Camera Agent с DHCP

## 🎯 Подтверждение: DHCP полностью поддерживается!

Да, камера будет работать **точно так же**, как задумано, даже если она получит IP-адрес через DHCP от роутера. Вот подробное объяснение:

## 🔄 Процесс работы с DHCP

### 1. **Получение IP через DHCP**
```
Роутер (DHCP сервер) → Камера получает IP (например, 192.168.1.100)
```

**Что происходит:**
- Камера подключается к роутеру
- Роутер выдает IP через DHCP (например, `192.168.1.100`)
- Камера получает IP, маску подсети, шлюз, DNS

### 2. **Агент автоматически определяет IP**
```python
def _detect_camera_ip(self) -> str:
    """Автоматическое определение IP камеры"""
    try:
        # Получение IP через socket
        with socket.socket(socket.AF_INET, socket.SOCK_DGRAM) as s:
            s.connect(("8.8.8.8", 80))
            local_ip = s.getsockname()[0]
            return local_ip  # Например: 192.168.1.100
    except Exception as e:
        return "127.0.0.1"  # Fallback
```

**Результат:** Агент автоматически узнает, что камера имеет IP `192.168.1.100`

### 3. **Локальное подключение агента к камере**
```
Агент → 127.0.0.1:554 (localhost)
ИЛИ
Агент → 192.168.1.100:554 (локальный IP)
```

**Важно:** Агент работает **локально** на той же камере, поэтому:
- Камера доступна как `127.0.0.1` (localhost)
- Или как `192.168.1.100` (локальный IP)
- **Не важно, какой IP получила камера от DHCP**

### 4. **Исходящее соединение к туннельному серверу**
```
Агент → Роутер (192.168.1.100) → Интернет → Туннельный сервер
```

**Ключевой момент:** Соединение **инициируется агентом** (исходящее):
- Роутер пропускает исходящий трафик
- NAT работает в сторону "изнутри наружу"
- **Не нужен проброс портов**

### 5. **Туннель на сервере**
```
Туннельный сервер → 127.0.0.1:8554 (локально на сервере)
```

**Результат:** Flussonic Watcher видит камеру как локальную на `127.0.0.1:8554`

## 🏗️ Детальная схема с DHCP

```
┌─────────────────────────────────────────────────────────────────┐
│                    IP-КАМЕРА (192.168.1.100)                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   RTSP Server   │  │  Camera Agent   │  │   DHCP Client   │ │
│  │ (127.0.0.1:554) │◄─┤   (наш код)     │─►│  (192.168.1.100)│ │
│  │                 │  │                 │  │                 │ │
│  │ - H.264/H.265   │  │ - Auto-detect   │  │ - DHCP получен  │ │
│  │ - Multiple      │  │ - Local access  │  │ - IP получен    │ │
│  │   Streams       │  │ - Tunnel client │  │ - Gateway set   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ Исходящее соединение
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    РОУТЕР (DHCP Server)                        │
│  - DHCP: 192.168.1.100 → Камера                               │
│  - NAT: Исходящий трафик разрешен                             │
│  - Firewall: Блокирует входящие соединения                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ Интернет
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   ТУННЕЛЬНЫЙ СЕРВЕР                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   WebSocket     │  │   TCP Tunnel    │  │   Local RTSP    │ │
│  │   Server        │◄─┤   Server        │─►│   Proxy         │ │
│  │                 │  │                 │  │                 │ │
│  │ - Прием агентов │  │ - TCP туннель   │  │ - 127.0.0.1:8554│ │
│  │ - Управление    │  │ - Прозрачность  │  │ - RTSP прокси   │ │
│  │ - Мониторинг    │  │ - NAT traversal │  │ - Flussonic API │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ Локальное подключение
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   FLUSSONIC WATCHER                            │
│  - Подключение к 127.0.0.1:8554 (локально)                     │
│  - Работает как с локальной камерой                             │
│  - Полная прозрачность туннеля                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 🔧 Конфигурация для DHCP

### Автоматическое определение IP
```json
{
  "camera": {
    "ip": "127.0.0.1",
    "auto_detect_ip": true,
    "rtsp_port": 554
  }
}
```

### Логи агента при определении IP
```
[STREAM] Обнаружен IP камеры: 192.168.1.100
[TUNNEL] Подключение к туннельному серверу...
[TUNNEL] Туннель установлен: 127.0.0.1:8554
[AGENT] Агент готов к работе
```

## 🎯 Преимущества DHCP + Tunnel

### 1. **Простота настройки**
- Камера автоматически получает IP
- Агент автоматически определяет IP
- Никаких статических настроек

### 2. **Безопасность**
- Нет открытых портов на роутере
- Исходящее соединение через NAT
- Туннель шифруется

### 3. **Масштабируемость**
- Любое количество камер с DHCP
- Автоматическое управление IP
- Централизованное управление

### 4. **Совместимость с Flussonic**
- Flussonic видит камеры как локальные
- Полная прозрачность туннеля
- Стандартный RTSP протокол

## 🚀 Пример работы

### Сценарий: Камера получила IP 192.168.1.100

1. **DHCP:** Роутер выдал `192.168.1.100`
2. **Агент:** Определил IP камеры
3. **Локальный доступ:** Агент подключился к `127.0.0.1:554`
4. **Туннель:** Создал соединение с туннельным сервером
5. **Flussonic:** Подключился к `127.0.0.1:8554` (локально на сервере)

### Результат:
- ✅ Камера работает с DHCP IP
- ✅ Туннель установлен
- ✅ Flussonic видит камеру как локальную
- ✅ Полная прозрачность

## 🔄 Смена IP адреса

Если камера получит новый IP от DHCP:

1. **Агент автоматически определит новый IP**
2. **Переподключится к туннельному серверу**
3. **Туннель будет восстановлен**
4. **Flussonic продолжит работу без перерыва**

## 📊 Мониторинг DHCP

### Статистика агента
```json
{
  "camera": {
    "ip": "192.168.1.100",
    "dhcp_enabled": true,
    "auto_detected": true
  },
  "tunnel": {
    "status": "connected",
    "server_port": 8554
  }
}
```

---

**Вывод: DHCP полностью поддерживается и работает точно так же, как задумано! Агент автоматически адаптируется к любому IP, полученному от DHCP.**



