# Туннельная архитектура Camera Agent

## 🎯 Как работает туннельная архитектура

### Проблема
IP-камера находится за NAT и недоступна извне. Flussonic Watcher не может подключиться к камере напрямую.

### Решение - Туннель
Агент создает **туннель** между камерой и туннельным сервером, делая камеру доступной как локальное устройство на сервере.

## 🔄 Процесс работы

### 1. Активация агента на камере
```
IP-камера (127.0.0.1:554) + Agent
```

### 2. Подключение к туннельному серверу
```
Agent → WebSocket → Туннельный сервер
```

### 3. Создание туннеля
```
Туннельный сервер создает TCP туннель:
127.0.0.1:8554 (на сервере) ↔ 127.0.0.1:554 (на камере)
```

### 4. Подключение Flussonic Watcher
```
Flussonic Watcher → 127.0.0.1:8554 (локально на сервере)
```

## 🏗️ Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                    IP-КАМЕРА (Edge Device)                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   RTSP Server   │  │  Camera Agent   │  │   Туннель       │ │
│  │   (127.0.0.1:554)│◄─┤   (наш код)     │─►│   Клиент        │ │
│  │                 │  │                 │  │                 │ │
│  │ - H.264/H.265   │  │ - WebSocket     │  │ - TCP туннель   │ │
│  │ - Multiple      │  │ - Туннель       │  │ - Прозрачность  │ │
│  │   Streams       │  │ - Heartbeat     │  │ - NAT traversal │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ WebSocket + TCP Tunnel
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    INTERNET + NAT/FIREWALL                     │
│  - Автоматический NAT Traversal                                │
│  - Шифрованное соединение                                      │
│  - TCP туннель для RTSP                                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   ТУННЕЛЬНЫЙ СЕРВЕР                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   WebSocket     │  │   TCP Tunnel    │  │   Local RTSP    │ │
│  │   Server        │◄─┤   Server        │─►│   Proxy         │ │
│  │                 │  │                 │  │                 │ │
│  │ - Прием агентов │  │ - TCP туннель   │  │ - 127.0.0.1:8554│ │
│  │ - Управление    │  │ - Прозрачность  │  │ - RTSP прокси   │ │
│  │ - Мониторинг    │  │ - NAT traversal │  │ - Flussonic API │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   FLUSSONIC WATCHER                            │
│  - Подключение к 127.0.0.1:8554 (локально)                     │
│  - Работает как с локальной камерой                             │
│  - Полная прозрачность туннеля                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 🔧 Компоненты системы

### 1. Camera Agent (на камере)
**Файл:** `agent/core/agent.py`

**Функции:**
- Подключение к туннельному серверу через WebSocket
- Создание TCP туннеля до локальной камеры
- Передача RTSP трафика через туннель
- Мониторинг состояния туннеля

### 2. Туннельный сервер (отдельно)
**Не входит в этот проект** - поднимается отдельно в вашей сети

**Функции:**
- Прием WebSocket подключений от агентов
- Создание TCP туннелей
- Проксирование RTSP трафика
- Предоставление локального доступа к камерам

### 3. Flussonic Watcher
**Внешняя система**

**Функции:**
- Подключение к камерам как к локальным устройствам
- Управление потоками
- Запись и анализ видео

## 🚀 Процесс установки и настройки

### 1. Настройка туннельного сервера
```bash
# На вашем сервере (отдельно от этого проекта)
# Запуск туннельного сервера
./tunnel-server --port 8080 --tunnel-port 8554
```

### 2. Создание прошивки агента
```bash
# Создание прошивки с настройками туннельного сервера
python tools/build_agent.py --camera dahua-2449s-il --output firmware/dahua-2449s-il
```

### 3. Настройка конфигурации агента
```json
{
  "agent": {
    "agent_id": "dahua-2449s-il-001",
    "tunnel_server_url": "ws://YOUR-TUNNEL-SERVER:8080/tunnel",
    "tunnel_server_token": "your-secret-token"
  },
  "tunnel": {
    "tunnel_port": 8554
  }
}
```

### 4. Установка на камеру
```bash
# Загрузка прошивки через веб-интерфейс камеры
# System → Maintenance → Upgrade
# Файл: dahua-2449s-il_firmware.tar.gz
```

### 5. Настройка Flussonic Watcher
```bash
# В Flussonic Watcher добавить камеру:
# RTSP URL: rtsp://127.0.0.1:8554/cam/realmonitor?channel=1&subtype=0
# Username: admin
# Password: admin
```

## 🔧 Технические детали

### TCP Туннель
```
Камера (127.0.0.1:554) ←→ Туннель ←→ Сервер (127.0.0.1:8554)
```

### WebSocket управление
```
Agent ←→ WebSocket ←→ Туннельный сервер
```

### RTSP Прозрачность
- Flussonic Watcher видит камеру как локальную
- Все RTSP команды проходят через туннель
- Полная совместимость с Flussonic API

## 📊 Мониторинг

### Статистика туннеля
```json
{
  "tunnel": {
    "status": "connected",
    "local_port": 8554,
    "remote_port": 554,
    "bytes_transferred": 1024000,
    "connections": 1,
    "uptime": 3600
  }
}
```

### API туннельного сервера
```bash
# Список активных туннелей
curl http://tunnel-server:8080/tunnels

# Статус конкретного туннеля
curl http://tunnel-server:8080/tunnels/dahua-2449s-il-001

# Управление туннелем
curl -X POST http://tunnel-server:8080/tunnels/dahua-2449s-il-001/restart
```

## 🎯 Преимущества туннельной архитектуры

### По сравнению с WebSocket проксированием:
1. **Прозрачность** - Flussonic видит камеру как локальную
2. **Совместимость** - полная совместимость с RTSP
3. **Производительность** - прямой TCP туннель
4. **Простота** - нет необходимости в специальной интеграции

### По сравнению с NAT пробросом:
1. **Безопасность** - нет открытых портов
2. **Управляемость** - централизованное управление
3. **Масштабируемость** - множество камер на одном сервере
4. **Мониторинг** - полная видимость соединений

## 🔮 Интеграция с Flussonic Watcher

### Автоматическое обнаружение
```
Flussonic Watcher → Сканирование 127.0.0.1:8554 → Обнаружение камеры
```

### Управление через API
```bash
# Добавление камеры в Flussonic
curl -X POST http://flussonic-watcher/api/cameras \
  -H "Content-Type: application/json" \
  -d '{
    "name": "dahua-2449s-il-001",
    "url": "rtsp://127.0.0.1:8554/cam/realmonitor?channel=1&subtype=0",
    "username": "admin",
    "password": "admin"
  }'
```

---

**Туннельная архитектура обеспечивает полную прозрачность для Flussonic Watcher, делая удаленные камеры доступными как локальные устройства.**
