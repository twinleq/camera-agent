# Camera Agent Firmware - ะะพะดัะพะฑะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั

## ๐ฏ ะะฑะทะพั ะฟัะพะตะบัะฐ

**Camera Agent Firmware** - ััะพ ัะตัะตะฝะธะต ะดะปั ะฒัััะฐะธะฒะฐะฝะธั ะฐะณะตะฝัะพะฒ ะฒ ะฟัะพัะธะฒะบั IP-ะบะฐะผะตั, ะฐะฝะฐะปะพะณะธัะฝะพะต [Flussonic Agent](https://flussonic.ru/doc/agent-with-watcher/). ะะณะตะฝั ัะตัะฐะตั ะบะปััะตะฒัะต ะฟัะพะฑะปะตะผั ะดะพัััะฟะฐ ะบ IP-ะบะฐะผะตัะฐะผ ัะตัะตะท NAT ะธ ะพะฑะตัะฟะตัะธะฒะฐะตั ััะฐะฑะธะปัะฝัั ะฟะตัะตะดะฐัั ะฒะธะดะตะพ ะฝะฐ ะพะฑะปะฐัะฝัะต ัะตัะฒะตัั.

## ๐๏ธ ะััะธัะตะบัััะฐ ัะตัะตะฝะธั

### ะัะพะฑะปะตะผะฐ, ะบะพัะพััั ัะตัะฐะตั ะฐะณะตะฝั

**ะะฑััะฝะฐั ััะตะผะฐ (ะฟัะพะฑะปะตะผั):**
```
ะะฑะปะฐัะฝัะน ัะตัะฒะตั โ NAT/Firewall โ IP-ะบะฐะผะตัะฐ (ะฝะตะดะพัััะฟะฝะฐ)
```
- ะะฐะผะตัะฐ ะฝะตะดะพัััะฟะฝะฐ ะธะทะฒะฝะต ะธะท-ะทะฐ NAT
- ะะตะพะฑัะพะดะธะผ ะฟัะพะฑัะพั ะฟะพััะพะฒ
- ะะตััะฐะฑะธะปัะฝะพะต ัะพะตะดะธะฝะตะฝะธะต
- ะะตั ะฑััะตัะธะทะฐัะธะธ ะฟัะธ ะฟะพัะตัะต ะฟะฐะบะตัะพะฒ

**ะะตัะตะฝะธะต ั Camera Agent (ััะฝะฝะตะปัะฝะฐั ะฐััะธัะตะบัััะฐ):**
```
IP-ะบะฐะผะตัะฐ + Agent โ NAT/Firewall โ ะขัะฝะฝะตะปัะฝัะน ัะตัะฒะตั โ Flussonic Watcher
                     โ
              ะะฐะผะตัะฐ ะดะพัััะฟะฝะฐ ะบะฐะบ 127.0.0.1 ะฝะฐ ัะตัะฒะตัะต
```
- ะะณะตะฝั ัะพะทะดะฐะตั ััะฝะฝะตะปั ะดะพ ััะฝะฝะตะปัะฝะพะณะพ ัะตัะฒะตัะฐ
- ะะฐ ัะตัะฒะตัะต ะบะฐะผะตัะฐ ััะฐะฝะพะฒะธััั ะดะพัััะฟะฝะฐ ะบะฐะบ `127.0.0.1:8554`
- Flussonic Watcher ะฟะพะดะบะปััะฐะตััั ะบ ะบะฐะผะตัะต ะบะฐะบ ะบ ะปะพะบะฐะปัะฝะพะผั ััััะพะนััะฒั
- ะะพะปะฝะฐั ะฟัะพะทัะฐัะฝะพััั ะดะปั Flussonic Watcher

### ะะตัะฐะปัะฝะฐั ะฐััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    IP-ะะะะะะ (Edge Device)                     โ
โ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ โ
โ  โ   RTSP Server   โ  โ  Camera Agent   โ  โ   File System   โ โ
โ  โ   (ะฒัััะพะตะฝะฝัะน)  โโโโค   (ะฝะฐั ะบะพะด)     โโโบโ   (ะฟัะพัะธะฒะบะฐ)    โ โ
โ  โ                 โ  โ                 โ  โ                 โ โ
โ  โ - H.264/H.265   โ  โ - WebSocket     โ  โ - ะะพะฝัะธะณััะฐัะธั  โ โ
โ  โ - Multiple      โ  โ - ะััะตัะธะทะฐัะธั   โ  โ - ะะพะณะธ          โ โ
โ  โ   Streams       โ  โ - NAT Traversal โ  โ - ะะฐะฟะธัะธ        โ โ
โ  โโโโโโโโโโโโโโโโโโโ  โ - ะะตัะตะฟะพะดะบะปััะตะฝะธะตโ  โโโโโโโโโโโโโโโโโโโ โ
โ                       โ - Heartbeat     โ                      โ
โ                       โโโโโโโโโโโโโโโโโโโ                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                โ
                                โ WebSocket + RTSP Stream
                                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    INTERNET + NAT/FIREWALL                     โ
โ  - ะะฒัะพะผะฐัะธัะตัะบะธะน NAT Traversal                                โ
โ  - ะจะธััะพะฒะฐะฝะฝะพะต ัะพะตะดะธะฝะตะฝะธะต                                      โ
โ  - ะััะตัะธะทะฐัะธั ะฟะพัะตััะฝะฝัั ะฟะฐะบะตัะพะฒ                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                โ
                                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   ะะะะะงะะซะ ะกะะะะะ                              โ
โ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ โ
โ  โ   WebSocket     โ  โ   Stream Relay  โ  โ   Management    โ โ
โ  โ   Server        โโโโค   Server        โโโบโ   API           โ โ
โ  โ                 โ  โ                 โ  โ                 โ โ
โ  โ - ะัะธะตะผ ะฐะณะตะฝัะพะฒ โ  โ - RTSP Relay    โ  โ - REST API      โ โ
โ  โ - Heartbeat     โ  โ - Load Balance  โ  โ - ะะพะฝะธัะพัะธะฝะณ    โ โ
โ  โ - ะะพะผะฐะฝะดั       โ  โ - Recording     โ  โ - ะะฝะฐะปะธัะธะบะฐ     โ โ
โ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                โ
                                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ะะะะฌะะะะะขะะะฌะกะะะ ะะะขะะะคะะะก                  โ
โ  - ะะตะฑ-ะฟะพััะฐะป ัะฟัะฐะฒะปะตะฝะธั                                        โ
โ  - ะะพะฑะธะปัะฝัะต ะฟัะธะปะพะถะตะฝะธั                                         โ
โ  - API ะดะปั ะธะฝัะตะณัะฐัะธะธ                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ง ะะพะผะฟะพะฝะตะฝัั ัะธััะตะผั

### 1. Camera Agent (ะะพะด ะฐะณะตะฝัะฐ)

**ะะฐัะฟะพะปะพะถะตะฝะธะต:** `agent/core/agent.py`

**ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ:**
- ะะพะดะบะปััะตะฝะธะต ะบ ะพะฑะปะฐัะฝะพะผั ัะตัะฒะตัั ัะตัะตะท WebSocket
- ะะพะปััะตะฝะธะต RTSP ะฟะพัะพะบะพะฒ ั ะบะฐะผะตัั
- ะััะตัะธะทะฐัะธั ะธ ะฟะตัะตะพัะฟัะฐะฒะบะฐ ะฟะพัะตััะฝะฝัั ะฟะฐะบะตัะพะฒ
- ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟะตัะตะฟะพะดะบะปััะตะฝะธะต ะฟัะธ ัะฑะพัั
- ะัะฟัะฐะฒะบะฐ heartbeat ะธ ััะฐัะธััะธะบะธ
- ะะฑัะฐะฑะพัะบะฐ ะบะพะผะฐะฝะด ะพั ัะตัะฒะตัะฐ

**ะะปััะตะฒัะต ะบะปะฐััั:**
```python
class CameraAgent:
    """ะัะฝะพะฒะฝะพะน ะบะปะฐัั ะฐะณะตะฝัะฐ"""
    - start()           # ะะฐะฟััะบ ะฐะณะตะฝัะฐ
    - stop()            # ะััะฐะฝะพะฒะบะฐ ะฐะณะตะฝัะฐ
    - _connect_to_cloud()  # ะะพะดะบะปััะตะฝะธะต ะบ ัะตัะฒะตัั
    - _start_streaming()   # ะะฐะฟััะบ ัััะธะผะธะฝะณะฐ
    - _monitoring_loop()   # ะะพะฝะธัะพัะธะฝะณ ัะพััะพัะฝะธั

class CloudConnection:
    """ะกะพะตะดะธะฝะตะฝะธะต ั ะพะฑะปะฐัะฝัะผ ัะตัะฒะตัะพะผ"""
    - register()        # ะะตะณะธัััะฐัะธั ะฝะฐ ัะตัะฒะตัะต
    - send_stream_data() # ะัะฟัะฐะฒะบะฐ ะฟะพัะพะบะฐ
    - send_heartbeat()  # ะัะฟัะฐะฒะบะฐ heartbeat

class StreamProcessor:
    """ะะฑัะฐะฑะพัะบะฐ ะฟะพัะพะบะพะฒ ะบะฐะผะตัั"""
    - start()           # ะะฐะฟััะบ ะพะฑัะฐะฑะพัะบะธ
    - get_stream_data() # ะะพะปััะตะฝะธะต ะดะฐะฝะฝัั ะฟะพัะพะบะฐ
    - stop()            # ะััะฐะฝะพะฒะบะฐ ะพะฑัะฐะฑะพัะบะธ
```

### 2. ะะฝััััะผะตะฝั ัะฑะพัะบะธ ะฟัะพัะธะฒะบะธ

**ะะฐัะฟะพะปะพะถะตะฝะธะต:** `tools/build_agent.py`

**ะคัะฝะบัะธะธ:**
- ะกะพะทะดะฐะฝะธะต ะฟัะพัะธะฒะบะธ ะดะปั ะบะพะฝะบัะตัะฝะพะน ะผะพะดะตะปะธ ะบะฐะผะตัั
- ะะตะฝะตัะฐัะธั ะฟะปะฐััะพัะผะพ-ัะฟะตัะธัะธัะฝะพะณะพ ะบะพะดะฐ
- ะกะพะทะดะฐะฝะธะต ะบะพะฝัะธะณััะฐัะธะพะฝะฝัั ัะฐะนะปะพะฒ
- ะกะพะทะดะฐะฝะธะต ัะบัะธะฟัะพะฒ ัััะฐะฝะพะฒะบะธ
- ะกะพะทะดะฐะฝะธะต ะฐััะธะฒะฐ ะฟัะพัะธะฒะบะธ

**ะะพะดะดะตัะถะธะฒะฐะตะผัะต ะบะฐะผะตัั:**
```python
camera_configs = {
    "dahua-2449s-il": {
        "platform": "linux_arm",
        "architecture": "armv7",
        "rtsp_port": 554,
        "stream_paths": [
            "/cam/realmonitor?channel=1&subtype=0",  # ะัะฝะพะฒะฝะพะน ะฟะพัะพะบ
            "/cam/realmonitor?channel=1&subtype=1"   # ะะพะดะฟะพัะพะบ
        ],
        "max_resolution": "2688x1520",
        "max_fps": 20,
        "codec": "H.265"
    }
}
```

### 3. ะะฑะปะฐัะฝัะน ัะตัะฒะตั

**ะะฐัะฟะพะปะพะถะตะฝะธะต:** `cloud-server/server.py`

**ะคัะฝะบัะธะธ:**
- ะัะธะตะผ WebSocket ะฟะพะดะบะปััะตะฝะธะน ะพั ะฐะณะตะฝัะพะฒ
- ะะตะณะธัััะฐัะธั ะฐะณะตะฝัะพะฒ
- ะะพะปััะตะฝะธะต heartbeat ะธ ััะฐัะธััะธะบะธ
- ะฃะฟัะฐะฒะปะตะฝะธะต ะฐะณะตะฝัะฐะผะธ ัะตัะตะท ะบะพะผะฐะฝะดั
- API ะดะปั ะฒะตะฑ-ะธะฝัะตััะตะนัะฐ

**API ัะฝะดะฟะพะธะฝัั:**
```
GET  /health              - ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั ัะตัะฒะตัะฐ
GET  /agents              - ะกะฟะธัะพะบ ะฐะณะตะฝัะพะฒ
GET  /agents/{id}         - ะะฝัะพัะผะฐัะธั ะพะฑ ะฐะณะตะฝัะต
POST /agents/{id}/control - ะฃะฟัะฐะฒะปะตะฝะธะต ะฐะณะตะฝัะพะผ
GET  /streams             - ะกะฟะธัะพะบ ะฟะพัะพะบะพะฒ
WS   /agent/{id}          - WebSocket ะดะปั ะฐะณะตะฝัะฐ
```

## ๐ ะัะพัะตัั ัะฐะฑะพัั

### 1. ะกะพะทะดะฐะฝะธะต ะฟัะพัะธะฒะบะธ

```bash
# ะกะพะทะดะฐะฝะธะต ะฟัะพัะธะฒะบะธ ะดะปั Dahua IPC-HFW2449S-S-IL
python tools/build_agent.py --camera dahua-2449s-il --output firmware/dahua-2449s-il
```

**ะงัะพ ะฟัะพะธััะพะดะธั:**
1. ะะพะฟะธัะพะฒะฐะฝะธะต ะฑะฐะทะพะฒะพะณะพ ะบะพะดะฐ ะฐะณะตะฝัะฐ
2. ะกะพะทะดะฐะฝะธะต ะฟะปะฐััะพัะผะพ-ัะฟะตัะธัะธัะฝัั ัะฐะนะปะพะฒ
3. ะะตะฝะตัะฐัะธั ะบะพะฝัะธะณััะฐัะธะธ ะดะปั ะบะฐะผะตัั
4. ะกะพะทะดะฐะฝะธะต ัะบัะธะฟัะพะฒ ัััะฐะฝะพะฒะบะธ
5. ะกะพะทะดะฐะฝะธะต ะฐััะธะฒะฐ ะฟัะพัะธะฒะบะธ (.tar.gz)

### 2. ะฃััะฐะฝะพะฒะบะฐ ะฝะฐ ะบะฐะผะตัั

```bash
# ะงะตัะตะท ะฒะตะฑ-ะธะฝัะตััะตะนั ะบะฐะผะตัั
# 1. ะัะบัััั http://IP-ะบะฐะผะตัั
# 2. System โ Maintenance โ Upgrade
# 3. ะะฐะณััะทะธัั dahua-2449s-il_firmware.tar.gz
# 4. ะะพะถะดะฐัััั ะฟะตัะตะทะฐะณััะทะบะธ
```

**ะงัะพ ะฟัะพะธััะพะดะธั:**
1. ะะฐัะฟะฐะบะพะฒะบะฐ ะฐััะธะฒะฐ ะฟัะพัะธะฒะบะธ
2. ะะพะฟะธัะพะฒะฐะฝะธะต ัะฐะนะปะพะฒ ะฐะณะตะฝัะฐ ะฒ ัะธััะตะผั
3. ะกะพะทะดะฐะฝะธะต systemd ัะตัะฒะธัะฐ
4. ะะบะปััะตะฝะธะต ะฐะฒัะพะทะฐะฟััะบะฐ

### 3. ะะฐะฟััะบ ะฐะณะตะฝัะฐ

```bash
# ะะฐ ะบะฐะผะตัะต
systemctl start camera-agent
systemctl enable camera-agent
```

**ะงัะพ ะฟัะพะธััะพะดะธั:**
1. ะะฐะณััะทะบะฐ ะบะพะฝัะธะณััะฐัะธะธ ะธะท `/etc/camera_agent/config.json`
2. ะะพะดะบะปััะตะฝะธะต ะบ ะพะฑะปะฐัะฝะพะผั ัะตัะฒะตัั ัะตัะตะท WebSocket
3. ะะตะณะธัััะฐัะธั ะฐะณะตะฝัะฐ ะฝะฐ ัะตัะฒะตัะต
4. ะะฐะฟััะบ ะฟะพะปััะตะฝะธั RTSP ะฟะพัะพะบะพะฒ
5. ะะฐัะฐะปะพ ะพัะฟัะฐะฒะบะธ ะดะฐะฝะฝัั ะฝะฐ ัะตัะฒะตั

### 4. ะะฐะฑะพัะฐ ะฐะณะตะฝัะฐ

**ะฆะธะบะป ัะฐะฑะพัั:**
1. **ะะพะดะบะปััะตะฝะธะต ะบ ัะตัะฒะตัั** - WebSocket ัะพะตะดะธะฝะตะฝะธะต
2. **ะะตะณะธัััะฐัะธั** - ะพัะฟัะฐะฒะบะฐ ะธะฝัะพัะผะฐัะธะธ ะพ ะบะฐะผะตัะต
3. **ะะพะปััะตะฝะธะต ะฟะพัะพะบะพะฒ** - ััะตะฝะธะต RTSP ั ะบะฐะผะตัั
4. **ะัะฟัะฐะฒะบะฐ ะดะฐะฝะฝัั** - ะฟะตัะตะดะฐัะฐ ะฝะฐ ัะตัะฒะตั ั ะฑััะตัะธะทะฐัะธะตะน
5. **Heartbeat** - ะฟะตัะธะพะดะธัะตัะบะฐั ะพัะฟัะฐะฒะบะฐ ััะฐัััะฐ
6. **ะะพะฝะธัะพัะธะฝะณ** - ะฟัะพะฒะตัะบะฐ ัะพะตะดะธะฝะตะฝะธั ะธ ะฟะตัะตะฟะพะดะบะปััะตะฝะธะต

## ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
camera-agent-firmware/
โโโ agent/                          # ะะพะด ะฐะณะตะฝัะฐ ะดะปั ะฒัััะฐะธะฒะฐะฝะธั
โ   โโโ core/
โ   โ   โโโ agent.py               # ะัะฝะพะฒะฝะพะน ะบะปะฐัั ะฐะณะตะฝัะฐ
โ   โโโ platform/
โ   โ   โโโ platform_specific.py   # ะะปะฐััะพัะผะพ-ัะฟะตัะธัะธัะฝัะน ะบะพะด
โ   โโโ streaming/
โ   โ   โโโ stream_handler.py      # ะะฑัะฐะฑะพัะบะฐ ะฟะพัะพะบะพะฒ
โ   โโโ networking/
โ       โโโ cloud_connection.py    # ะกะพะตะดะธะฝะตะฝะธะต ั ะพะฑะปะฐะบะพะผ
โโโ cloud-server/                   # ะะฑะปะฐัะฝัะน ัะตัะฒะตั
โ   โโโ server.py                  # FastAPI ัะตัะฒะตั
โโโ tools/                          # ะะฝััััะผะตะฝัั
โ   โโโ build_agent.py             # ะกะฑะพััะธะบ ะฟัะพัะธะฒะบะธ
โโโ firmware/                       # ะกะพะทะดะฐะฝะฝัะต ะฟัะพัะธะฒะบะธ
โ   โโโ dahua-2449s-il/
โ       โโโ dahua-2449s-il_firmware.tar.gz
โ       โโโ config.json
โ       โโโ install.sh
โ       โโโ INSTALL.md
โโโ docs/                           # ะะพะบัะผะตะฝัะฐัะธั
โโโ example/                        # ะัะธะผะตัั
โโโ requirements.txt               # ะะฐะฒะธัะธะผะพััะธ
```

## ๐ง ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ

### NAT Traversal

**ะัะพะฑะปะตะผะฐ:** ะะฐะผะตัะฐ ะทะฐ NAT ะฝะตะดะพัััะฟะฝะฐ ะธะทะฒะฝะต
**ะะตัะตะฝะธะต:** ะะณะตะฝั ะธะฝะธัะธะธััะตั ะธััะพะดััะตะต ัะพะตะดะธะฝะตะฝะธะต

```python
# ะะณะตะฝั ะฟะพะดะบะปััะฐะตััั ะบ ัะตัะฒะตัั
websocket = await websockets.connect("wss://cloud-server.com/agent/agent-id")

# ะกะตัะฒะตั ะฟะพะปััะฐะตั ะฟะพะดะบะปััะตะฝะธะต ะธ ะผะพะถะตั ะพัะฟัะฐะฒะปััั ะบะพะผะฐะฝะดั
await websocket.send(json.dumps({
    "type": "command",
    "data": {"action": "restart"}
}))
```

### ะััะตัะธะทะฐัะธั

**ะัะพะฑะปะตะผะฐ:** ะะพัะตัั ะฟะฐะบะตัะพะฒ ะฟัะธ ะฝะตััะฐะฑะธะปัะฝะพะผ ัะพะตะดะธะฝะตะฝะธะธ
**ะะตัะตะฝะธะต:** ะะพะบะฐะปัะฝัะน ะฑััะตั ั ะฟะพะฒัะพัะฝะพะน ะพัะฟัะฐะฒะบะพะน

```python
class CameraAgent:
    def __init__(self):
        self.buffer = []  # ะััะตั ะดะปั ะฟะพัะตััะฝะฝัั ะฟะฐะบะตัะพะฒ
    
    async def _send_to_cloud(self, data: bytes):
        success = await self.connection.send_stream_data(data)
        if not success:
            # ะะพะฑะฐะฒะปะตะฝะธะต ะฒ ะฑััะตั ะดะปั ะฟะพะฒัะพัะฝะพะน ะพัะฟัะฐะฒะบะธ
            self.buffer.append(data)
            await self._retry_buffered_data()
```

### ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟะตัะตะฟะพะดะบะปััะตะฝะธะต

```python
async def _monitoring_loop(self):
    while self._running:
        try:
            await self._send_heartbeat()
            await self._check_connection()
        except Exception as e:
            await self._handle_connection_error()
            # ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟะตัะตะฟะพะดะบะปััะตะฝะธะต
            await self._reconnect()
```

### ะะพะดะดะตัะถะธะฒะฐะตะผัะต ะฟัะพัะพะบะพะปั

**RTSP ะฟะพัะพะบะธ:**
- ะัะฝะพะฒะฝะพะน ะฟะพัะพะบ: `/cam/realmonitor?channel=1&subtype=0`
- ะะพะดะฟะพัะพะบ: `/cam/realmonitor?channel=1&subtype=1`
- ะัะดะธะพ: `/cam/realmonitor?channel=1&subtype=2`

**WebSocket ัะพะตะดะธะฝะตะฝะธะต:**
- ะะตะณะธัััะฐัะธั ะฐะณะตะฝัะฐ
- ะะตัะตะดะฐัะฐ ะฟะพัะพะบะพะฒ
- Heartbeat ะธ ััะฐัะธััะธะบะฐ
- ะะพะผะฐะฝะดั ัะฟัะฐะฒะปะตะฝะธั

## ๐๏ธ ะะพะฝัะธะณััะฐัะธั

### ะัะฝะพะฒะฝะฐั ะบะพะฝัะธะณััะฐัะธั ะฐะณะตะฝัะฐ

```json
{
  "agent": {
    "agent_id": "dahua-2449s-il-001",
    "cloud_server_url": "ws://your-server.com:8080/agent",
    "cloud_server_token": "your-secret-token",
    "log_level": "INFO"
  },
  "streaming": {
    "quality": "high",
    "buffer_size": 2097152,
    "rtsp_port": 554,
    "stream_paths": [
      "/cam/realmonitor?channel=1&subtype=0",
      "/cam/realmonitor?channel=1&subtype=1"
    ]
  },
  "network": {
    "connection_timeout": 30,
    "reconnect_interval": 10,
    "heartbeat_interval": 30
  }
}
```

### ะะพะฝัะธะณััะฐัะธั ะดะปั ะบะพะฝะบัะตัะฝะพะน ะบะฐะผะตัั

```json
{
  "camera": {
    "model": "dahua-2449s-il",
    "max_resolution": "2688x1520",
    "max_fps": 20,
    "codec": "H.265",
    "features": ["WDR", "3D-DNR", "Smart Detection"]
  }
}
```

## ๐ ะะพะฝะธัะพัะธะฝะณ ะธ ัะฟัะฐะฒะปะตะฝะธะต

### ะกัะฐัะธััะธะบะฐ ะฐะณะตะฝัะฐ

```python
stats = {
    "bytes_sent": 1024000,      # ะัะฟัะฐะฒะปะตะฝะพ ะฑะฐะนั
    "bytes_received": 512000,   # ะะพะปััะตะฝะพ ะฑะฐะนั
    "packets_lost": 5,          # ะะพัะตััะฝะพ ะฟะฐะบะตัะพะฒ
    "reconnections": 2,         # ะะตัะตะฟะพะดะบะปััะตะฝะธะน
    "uptime": 3600,             # ะัะตะผั ัะฐะฑะพัั (ัะตะบ)
    "buffer_size": 1024         # ะะฐะทะผะตั ะฑััะตัะฐ
}
```

### API ัะฟัะฐะฒะปะตะฝะธั

```bash
# ะะพะปััะตะฝะธะต ััะฐัััะฐ ะฐะณะตะฝัะฐ
curl http://localhost:8080/agents/dahua-2449s-il-001

# ะัะฟัะฐะฒะบะฐ ะบะพะผะฐะฝะดั ะฐะณะตะฝัั
curl -X POST http://localhost:8080/agents/dahua-2449s-il-001/control \
  -H "Content-Type: application/json" \
  -d '{"command": "restart"}'

# ะะพะปััะตะฝะธะต ัะฟะธัะบะฐ ะฟะพัะพะบะพะฒ
curl http://localhost:8080/streams
```

### ะะพะณะธัะพะฒะฐะฝะธะต

```bash
# ะัะพัะผะพัั ะปะพะณะพะฒ ะฐะณะตะฝัะฐ ะฝะฐ ะบะฐะผะตัะต
journalctl -u camera-agent -f

# ะคะฐะนะปั ะปะพะณะพะฒ
tail -f /var/log/camera_agent/agent.log
```

## ๐ ะะตะทะพะฟะฐัะฝะพััั

### ะจะธััะพะฒะฐะฝะธะต ัะพะตะดะธะฝะตะฝะธั

```python
# WebSocket ั SSL
websocket_url = "wss://secure-server.com/agent"

# ะขะพะบะตะฝ ะฐะฒัะพัะธะทะฐัะธะธ
headers = {
    "Authorization": f"Bearer {agent_token}"
}
```

### ะััะตะฝัะธัะธะบะฐัะธั ะฐะณะตะฝัะพะฒ

```python
# ะะตะณะธัััะฐัะธั ั ัะพะบะตะฝะพะผ
registration_data = {
    "agent_id": agent_id,
    "token": cloud_server_token,
    "camera_model": "dahua-2449s-il",
    "capabilities": ["rtsp", "recording", "motion_detection"]
}
```

## ๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต

### 1. ะะฐะฟััะบ ะพะฑะปะฐัะฝะพะณะพ ัะตัะฒะตัะฐ

```bash
cd cloud-server
python server.py --host 0.0.0.0 --port 8080
```

### 2. ะกะพะทะดะฐะฝะธะต ะฟัะพัะธะฒะบะธ

```bash
python tools/build_agent.py --camera dahua-2449s-il --output firmware/dahua-2449s-il
```

### 3. ะฃััะฐะฝะพะฒะบะฐ ะฝะฐ ะบะฐะผะตัั

```bash
# ะะฐะณััะทะบะฐ ัะตัะตะท ะฒะตะฑ-ะธะฝัะตััะตะนั
# ะะปะธ ัะตัะตะท SSH:
scp dahua-2449s-il_firmware.tar.gz admin@192.168.1.100:/tmp/
ssh admin@192.168.1.100 "cd /tmp && tar -xzf dahua-2449s-il_firmware.tar.gz && ./install.sh"
```

### 4. ะะฐัััะพะนะบะฐ ะธ ะทะฐะฟััะบ

```bash
# ะะฐ ะบะฐะผะตัะต
nano /etc/camera_agent/config.json  # ะะฐัััะพะนะบะฐ
systemctl start camera-agent        # ะะฐะฟััะบ
systemctl enable camera-agent       # ะะฒัะพะทะฐะฟััะบ
```

## ๐ ะัะตะธะผััะตััะฒะฐ ัะตัะตะฝะธั

### ะะพ ััะฐะฒะฝะตะฝะธั ั ะพะฑััะฝัะผ ะฟะพะดัะพะดะพะผ:

1. **NAT Traversal** - ะฝะต ะฝัะถะตะฝ ะฟัะพะฑัะพั ะฟะพััะพะฒ
2. **ะกัะฐะฑะธะปัะฝะพััั** - ะฐะฒัะพะผะฐัะธัะตัะบะพะต ะฟะตัะตะฟะพะดะบะปััะตะฝะธะต
3. **ะััะตัะธะทะฐัะธั** - ะฝะตั ะฟะพัะตัะธ ะดะฐะฝะฝัั ะฟัะธ ัะฑะพัั
4. **ะะฐัััะฐะฑะธััะตะผะพััั** - ัะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพะต ัะฟัะฐะฒะปะตะฝะธะต
5. **ะะตะทะพะฟะฐัะฝะพััั** - ัะธััะพะฒะฐะฝะฝะพะต ัะพะตะดะธะฝะตะฝะธะต
6. **ะะพะฝะธัะพัะธะฝะณ** - ะฟะพะปะฝะฐั ะฒะธะดะธะผะพััั ัะพััะพัะฝะธั

### ะะพ ััะฐะฒะฝะตะฝะธั ั Flussonic Agent:

1. **ะัะบััััะน ะบะพะด** - ะฟะพะปะฝะฐั ะบะฐััะพะผะธะทะฐัะธั
2. **ะะพะดัะปัะฝะพััั** - ะปะตะณะบะพ ัะฐััะธัััั ััะฝะบัะธะพะฝะฐะปัะฝะพััั
3. **ะะธะฑะบะพััั** - ะฟะพะดะดะตัะถะบะฐ ัะฐะทะฝัั ะฟัะพัะพะบะพะปะพะฒ
4. **ะะพะบัะผะตะฝัะฐัะธั** - ะฟะพะดัะพะฑะฝัะต ะธะฝััััะบัะธะธ

## ๐ฎ ะะพะทะผะพะถะฝะพััะธ ัะฐััะธัะตะฝะธั

### ะะปะฐะฝะธััะตะผัะต ััะฝะบัะธะธ:

1. **AI ะดะตัะตะบัะธั** - ะธะฝัะตะณัะฐัะธั ั TensorFlow/PyTorch
2. **Edge storage** - ะปะพะบะฐะปัะฝะพะต ััะฐะฝะตะฝะธะต ะทะฐะฟะธัะตะน
3. **Multiple servers** - ะฟะพะดะบะปััะตะฝะธะต ะบ ะฝะตัะบะพะปัะบะธะผ ัะตัะฒะตัะฐะผ
4. **Load balancing** - ัะฐัะฟัะตะดะตะปะตะฝะธะต ะฝะฐะณััะทะบะธ
5. **Mobile apps** - ะผะพะฑะธะปัะฝัะต ะฟัะธะปะพะถะตะฝะธั ัะฟัะฐะฒะปะตะฝะธั
6. **Analytics** - ะฐะฝะฐะปะธัะธะบะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะะฝัะตะณัะฐัะธะธ:

1. **Flussonic Watcher** - ัะพะฒะผะตััะธะผะพััั ั Flussonic
2. **ONVIF** - ััะฐะฝะดะฐััะฝะฐั ัะพะฒะผะตััะธะผะพััั
3. **REST API** - ะธะฝัะตะณัะฐัะธั ั ะฒะฝะตัะฝะธะผะธ ัะธััะตะผะฐะผะธ
4. **Webhooks** - ัะฒะตะดะพะผะปะตะฝะธั ะพ ัะพะฑััะธัั

---

**Camera Agent Firmware** - ััะพ ะฟะพะปะฝะพัะตะฝะฝะพะต ัะตัะตะฝะธะต ะดะปั ะฒัััะฐะธะฒะฐะฝะธั ะฐะณะตะฝัะพะฒ ะฒ IP-ะบะฐะผะตัั, ะพะฑะตัะฟะตัะธะฒะฐััะตะต ะฝะฐะดะตะถะฝัั ะธ ะผะฐัััะฐะฑะธััะตะผัั ะฟะตัะตะดะฐัั ะฒะธะดะตะพ ะฝะฐ ะพะฑะปะฐัะฝัะต ะฟะปะฐััะพัะผั ะฒะธะดะตะพะฝะฐะฑะปัะดะตะฝะธั.

