# –ê–Ω–∞–ª–∏–∑ Flussonic Agent (Peeklio)

## üìå –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–ü—Ä–æ—à–∏–≤–∫–∞**: Dahua DH-IPC-HDBW2431FP-AS-0280B  
**–ß–∏–ø—Å–µ—Ç**: Mstar 327DE  
**–ê–≥–µ–Ω—Ç**: peeklio1 (Flussonic Agent)  
**–í–µ—Ä—Å–∏—è**: V2.820.1015003.0.T.210928

---

## üîç –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞ (app.sh)

–ò–∑ —Ñ–∞–π–ª–∞ `/mnt/app/app.sh` –±—ã–ª–∏ –∏–∑–≤–ª–µ—á–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:

```bash
# –ü–æ–ª—É—á–µ–Ω–∏–µ Device ID –∏–∑ /dev/armbenv
deviceid=$(getdeviceid.sh)

# –ó–∞–ø—É—Å–∫ Flussonic Agent (peeklio1)
./peeklio1 -c /mnt/mtd/Config/peeklio.cfg \
           -A C1.pem \
           -e peeklioroot.crt \
           -M 2956 \
           -S $deviceid
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| `-c` | `/mnt/mtd/Config/peeklio.cfg` | –ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É |
| `-A` | `C1.pem` | SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ |
| `-e` | `peeklioroot.crt` | Root SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ |
| `-M` | `2956` | –ü–æ—Ä—Ç –¥–ª—è —Ç—É–Ω–Ω–µ–ª—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ) |
| `-S` | `$deviceid` | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ |

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Flussonic Agent

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```
–ö–∞–º–µ—Ä–∞                      Flussonic Watcher Server
  ‚îÇ                                    ‚îÇ
  ‚îú‚îÄ‚îÄ –ü–æ–ª—É—á–∞–µ—Ç deviceid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ   (–∏–∑ /dev/armbenv)                ‚îÇ
  ‚îÇ                                    ‚îÇ
  ‚îú‚îÄ‚îÄ –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket ‚îÄ‚îÄ‚îÄ‚ñ∫
  ‚îÇ   (—Å SSL –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π)          ‚îÇ
  ‚îÇ                                    ‚îÇ
  ‚îú‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫
  ‚îÇ   {"device_id": "xxx"}             ‚îÇ
  ‚îÇ                                    ‚îÇ
  ‚îÇ‚óÑ‚îÄ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
```

### 2. –¢—É–Ω–Ω–µ–ª—å (–æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º)

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**

1. –ê–≥–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
2. –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å –Ω–∞ –ø–æ—Ä—Ç—É **2956**
3. –ö–∞–º–µ—Ä–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–∞ –∫–∞–∫ `127.0.0.1:2956` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
4. Flussonic Watcher –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ `rtsp://127.0.0.1:2956/cam/realmonitor`

**–°—Ö–µ–º–∞:**

```
Flussonic Watcher (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
          ‚Üì
   rtsp://127.0.0.1:2956
          ‚Üì
   [Tunnel Bridge Port 2956]
          ‚Üì
   [Internet / NAT]
          ‚Üì
   [WebSocket Connection]
          ‚Üì
   peeklio1 –∞–≥–µ–Ω—Ç (–Ω–∞ –∫–∞–º–µ—Ä–µ)
          ‚Üì
   rtsp://192.168.1.10:554 (–ª–æ–∫–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞)
```

### 3. SSL/TLS –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

Flussonic Agent –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤—É—Ö—Å—Ç–æ—Ä–æ–Ω–Ω—é—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é:

- **C1.pem** - —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–∫–∞–º–µ—Ä—ã)
- **peeklioroot.crt** - root —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞

–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- ‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞
- ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∫–∞–º–µ—Ä—ã
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—à–∏–≤–∫–∏

```
firmware (30MB –∞—Ä—Ö–∏–≤)
‚îú‚îÄ‚îÄ kernel.img (2.5MB)
‚îú‚îÄ‚îÄ romfs-x.squashfs.img (19MB) ‚Üê –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
‚îÇ   ‚îú‚îÄ‚îÄ /mnt/app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ peeklio1 ‚Üê –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –∞–≥–µ–Ω—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ C1.pem ‚Üê SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ peeklioroot.crt ‚Üê Root SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.sh ‚Üê –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ /mnt/mtd/Config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ peeklio.cfg ‚Üê –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ /dev/armbenv ‚Üê Device ID –∫–∞–º–µ—Ä—ã
‚îú‚îÄ‚îÄ web-x.squashfs.img (7.2MB) ‚Üê Web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îú‚îÄ‚îÄ dhboot.bin.img
‚îú‚îÄ‚îÄ dhboot-min.bin.img
‚îî‚îÄ‚îÄ partition-x.cramfs.img
```

---

## üí° –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏

### 1. Device ID

```bash
# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ /dev/armbenv
deviceid=$(cat /dev/armbenv | grep -o 'mac=[0-9A-Fa-f:]*' | cut -d'=' -f2 | tr -d ':')
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MAC-–∞–¥—Ä–µ—Å –∫–∞–º–µ—Ä—ã –∫–∞–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.

### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (peeklio.cfg)

–§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ):

```ini
[server]
url=wss://flussonic-server.example.com/agent
port=443

[tunnel]
port=2956

[ssl]
client_cert=C1.pem
root_cert=peeklioroot.crt

[camera]
rtsp_url=rtsp://127.0.0.1:554/cam/realmonitor
```

### 3. Heartbeat

–ê–≥–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ heartbeat –ø–∞–∫–µ—Ç—ã –¥–ª—è:
- –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –∫–∞–º–µ—Ä—ã
- –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫

---

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ –Ω–∞—à–µ–º –∞–≥–µ–Ω—Ç–µ

–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ Flussonic Agent –º—ã –¥–æ–±–∞–≤–∏–ª–∏:

### 1. –ü—Ä–æ—Ç–æ–∫–æ–ª Peeklio (`agent/protocols/peeklio_protocol.py`)

```python
class PeeklioProtocol:
    """–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Flussonic Watcher"""
    
    - SSL –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–∫–ª–∏–µ–Ω—Ç + —Å–µ—Ä–≤–µ—Ä)
    - Device ID –∏–∑ armbenv
    - –¢—É–Ω–Ω–µ–ª—å –Ω–∞ –ø–æ—Ä—Ç—É 2956
    - Heartbeat –º–µ—Ö–∞–Ω–∏–∑–º
    - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∫–æ–º–∞–Ω–¥—ã
```

### 2. –†–µ–∂–∏–º—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

- **Tunnel Mode** - –∫–∞–∫ —É peeklio (—á–µ—Ä–µ–∑ WebSocket + —Ç—É–Ω–Ω–µ–ª—å)
- **P2P Mode** - –ø—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ STUN/TURN
- **Hybrid Mode** - P2P —Å fallback –Ω–∞ —Ç—É–Ω–Ω–µ–ª—å

### 3. –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IP (DHCP)

```python
async def _detect_camera_ip(self) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π IP –∫–∞–º–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"""
    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ DHCP –∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö IP
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: Flussonic Agent vs –ù–∞—à Agent

| –§—É–Ω–∫—Ü–∏—è | Flussonic Agent | –ù–∞—à Agent |
|---------|----------------|-----------|
| **–¢—É–Ω–Ω–µ–ª—å** | ‚úÖ Port 2956 | ‚úÖ Port 2956 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è) |
| **SSL/TLS** | ‚úÖ –î–≤—É—Ö—Å—Ç–æ—Ä–æ–Ω–Ω—è—è | ‚úÖ –î–≤—É—Ö—Å—Ç–æ—Ä–æ–Ω–Ω—è—è |
| **Device ID** | ‚úÖ –ò–∑ armbenv | ‚úÖ –ò–∑ armbenv + fallback |
| **P2P** | ‚ùå –ù–µ—Ç | ‚úÖ STUN/TURN + WebRTC |
| **Hybrid** | ‚ùå –¢–æ–ª—å–∫–æ —Ç—É–Ω–Ω–µ–ª—å | ‚úÖ P2P + Tunnel fallback |
| **DHCP** | ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | ‚úÖ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ |
| **–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è** | ‚úÖ | ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è |
| **API** | ‚ö†Ô∏è –ó–∞–∫—Ä—ã—Ç—ã–π | ‚úÖ –û—Ç–∫—Ä—ã—Ç—ã–π REST API |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** | ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π | ‚úÖ Prometheus + Grafana |
| **–õ–∏—Ü–µ–Ω–∑–∏—è** | ‚ö†Ô∏è –ü—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω–∞—è | ‚úÖ Open Source |

---

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–∞—à–µ–≥–æ –∞–≥–µ–Ω—Ç–∞

1. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Flussonic Watcher
2. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ P2P –∏ hybrid —Ä–µ–∂–∏–º–æ–≤
3. **–û—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å** - open source, –º–æ–∂–Ω–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus
5. **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –∫–∞–º–µ—Ä–∞—Ö (–Ω–µ —Ç–æ–ª—å–∫–æ Dahua)

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≥–µ–Ω—Ç–∞ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞–º–µ—Ä–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Flussonic Watcher
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—É–Ω–Ω–µ–ª—å (–ø–æ—Ä—Ç 2956)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SSL –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å P2P —Ä–µ–∂–∏–º

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

- [ ] –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—à–∏–≤–∫—É –¥–ª—è Dahua DH-IPC-HDBW2431FP-AS-0280B
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å `peeklio1` –Ω–∞ –Ω–∞—à –∞–≥–µ–Ω—Ç
- [ ] –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å `app.sh`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [ ] –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- [ ] API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [ ] Troubleshooting guide

---

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Flussonic Agent Documentation](https://flussonic.ru/doc/agent-with-watcher/)
- [–ù–∞—à —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π](https://github.com/twinleq/camera-agent)
- [RTSP Protocol](https://www.rfc-editor.org/rfc/rfc7826)
- [WebSocket Protocol](https://datatracker.ietf.org/doc/html/rfc6455)

---

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞**: 7 –æ–∫—Ç—è–±—Ä—è 2025  
**–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª**: AI Assistant  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, –∞–≥–µ–Ω—Ç –¥–æ—Ä–∞–±–æ—Ç–∞–Ω